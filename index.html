<!DOCTYPE html>
<html>
    <head>
        <title>Snake!</title>
    </head>

    <body>
        <canvas id="canvas" width="640" height="640"></canvas>

        <script src='https://code.jquery.com/jquery-2.1.0.js'></script>

        <a id="score"></a>
        
        <script>
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");

            var width = canvas.width;
            var height = canvas.height;

            var blockSize = 20;
            var pieceOfBlock = blockSize / 5;
            var widthInBlocks = width / blockSize;
            var heightInBlocks = height / blockSize;

            var score = 0;

            function drawBorder() {
                ctx.fillStyle = "Green";
                ctx.fillRect(0, 0, width, blockSize);
                ctx.fillRect(0, height - blockSize, width, blockSize);
                ctx.fillRect(0, 0, blockSize, height);
                ctx.fillRect(width - blockSize, 0, blockSize, height);
            }

            function drawScore() {
                $('#score').text(`Score: ${score}`)
            }

            function gameOver() {
                clearInterval(intervalId);
                ctx.font = "60px Courier";
                ctx.fillStyle = "Black";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("Game Over", width / 2, height / 2);
            }

            function circle(x, y, radius, fillCircle) {
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2, false);
                if (fillCircle) {
                    ctx.fill();
                } else {
                    ctx.stroke();
                }
            }

            function Block(col, row) {
                this.col = col;
                this.row = row;
            }

            Block.prototype.drawSquare = function (color) {
                var x = this.col * blockSize;
                var y = this.row * blockSize;
                ctx.fillStyle = color;
                ctx.fillRect(x, y, blockSize, blockSize);
            }

            function drawHead() {
                ctx.beginPath();
                ctx.moveTo(-5, -5);
                ctx.lineTo(5, -5); 
                ctx.lineTo(5, 5);
                ctx.lineTo(-5, 5);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(5, 0, 5, 0, Math.PI*2, false);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(-1, -5, 3, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "White";

                ctx.beginPath();
                ctx.arc(-1, -5, 2, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Black";

                ctx.beginPath();
                ctx.arc(-1, -5, 1, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Blue";

                ctx.beginPath();
                ctx.arc(-1, 5, 3, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "White";

                ctx.beginPath();
                ctx.arc(-1, 5, 2, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Black";

                ctx.beginPath();
                ctx.arc(-1, 5, 1, 0, Math.PI*2, false);
                ctx.fill();
            }

            function drawTail() {
                var coordinates = [[-5, 0], [5, 5], [5, -5]];
                ctx.beginPath();
                ctx.moveTo(5, -5);
                for (var i = 0; i < coordinates.length; i++) {
                    ctx.lineTo(coordinates[i][0], coordinates[i][1]);
                }
                ctx.fill();
            }

            function drawTurn() {
                ctx.beginPath();
                ctx.moveTo(-5, -5);
                ctx.lineTo(0, -5);
                ctx.lineTo(5, 0);
                ctx.lineTo(5, 5);
                ctx.lineTo(-5, 5);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(0, 0, 5, 0, Math.PI*2, false);
                ctx.fill();
            }

            function drawHeadWithOpenMouth() {
                ctx.beginPath();
                ctx.moveTo(-5, -5);
                ctx.lineTo(5, -5); 
                ctx.lineTo(5, 5);
                ctx.lineTo(-5, 5);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(5, 0, 5, 0, Math.PI*2, false);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(-1, -5, 3, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "White";

                ctx.beginPath();
                ctx.arc(-1, -5, 2, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Black";

                ctx.beginPath();
                ctx.arc(-1, -5, 1, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Blue";
                
                ctx.beginPath();
                ctx.arc(-1, 5, 3, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "White";

                ctx.beginPath();
                ctx.arc(-1, 5, 2, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Black";

                ctx.beginPath();
                ctx.arc(-1, 5, 1, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "Blue";

                ctx.beginPath();
                ctx.arc(5, 0, 6, 1.5*Math.PI, 0.5*Math.PI, false);
                ctx.fill();

                ctx.fillStyle = "DarkBlue";

                ctx.beginPath();
                ctx.ellipse(6, 0, 4, 5, 0, 1.5*Math.PI, 0.5*Math.PI);
                ctx.fill();

                ctx.fillStyle = "White";

                ctx.beginPath();
                ctx.moveTo(6, -2.5);
                ctx.lineTo(8, -1.5);
                ctx.lineTo(6, -1.5);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(6, 1.5);
                ctx.lineTo(8, 1.5);
                ctx.lineTo(6, 2.5);
                ctx.fill();
            }

            function drawApple() {
                ctx.beginPath();
                ctx.arc(0, 0, 5, 0, Math.PI*2, false);
                ctx.fill();

                ctx.fillStyle = "DarkGreen";

                ctx.beginPath();
                ctx.moveTo(-0.7, -5);
                ctx.lineTo(-0.7, -7.5);
                ctx.lineTo(0.7, -7.5);
                ctx.lineTo(0.7, -5);
                ctx.fill();
            }

            Block.prototype.drawElement = function (bodyPart, direction, color) {
                var x = this.col;
                var y = this.row;

                ctx.fillStyle = color;
                ctx.translate(x*blockSize+blockSize/2, y*blockSize+blockSize/2);
                ctx.rotate(direction*Math.PI/2);
                ctx.scale(blockSize/10, blockSize/10);
                if (bodyPart === 0) drawTail();
                if (bodyPart === 1) drawHead(); 
                if (bodyPart === 2) drawTurn();
                if (bodyPart === 3) drawHeadWithOpenMouth();
                if (bodyPart === 4) drawApple();
                ctx.resetTransform();
            }

            Block.prototype.drawCircle = function (color, radius) {
                var centerX = this.col * blockSize + blockSize / 2;
                var centerY = this.row * blockSize + blockSize / 2;
                ctx.fillStyle = color;
                circle(centerX, centerY, radius, true);
            }

            Block.prototype.equal = function (otherBlock) {
                return this.col === otherBlock.col && this.row === otherBlock.row;
            }

            function drawBoard() {
                for (var x = 0; x < heightInBlocks; x++) {
                    for (var y = 0; y < widthInBlocks*heightInBlocks; y++) {
                        if ((y+x)%2 === 0) {
                            ctx.fillStyle = "LimeGreen";
                        } else {
                            ctx.fillStyle = "ForestGreen";
                        }
                        ctx.fillRect(x*blockSize, y*blockSize, blockSize, blockSize);
                    }
                }
            }

            function Snake() {
                this.segments = [
                    new Block(7, 5), 
                    new Block(6, 5), 
                    new Block(5, 5), 
                    new Block(4, 5)
                ];

                this.direction = "right";
                this.nextDirection = "right";
            }

            Snake.prototype.draw = function () {
                var x = this.col;
                var y = this.row;

                for (var i = 0; i < this.segments.length; i++) {
                    if (i === this.segments.length-1) {
                        var dx = this.segments[i].col - this.segments[i-1].col;
                        var dy = this.segments[i].row - this.segments[i-1].row

                        if (dx === -1 && dy === 0) {
                            this.segments[i].drawElement(0, 0, "Blue");
                        } else
                        if (dx === 0 && dy === -1) {
                            this.segments[i].drawElement(0, 1, "Blue");
                        } else
                        if (dx === 1 && dy === 0) {
                            this.segments[i].drawElement(0, 2, "Blue");
                        } else
                        if (dx === 0 && dy === 1) {
                            this.segments[i].drawElement(0, 3, "Blue");
                        }
                        return;
                    }
                    if (i === 0) {
                        var dx = this.segments[0].col - this.segments[1].col;
                        var dy = this.segments[0].row - this.segments[1].row;

                        if (dx === -1 && dy === 0) {
                            this.segments[i].drawElement(1, 2, "Blue");
                        }
                        if (dx === 0 && dy === -1) {
                            this.segments[i].drawElement(1, 3, "Blue");
                        }
                        if (dx === 1 && dy === 0) {
                            this.segments[i].drawElement(1, 0, "Blue");
                        }
                        if (dx === 0 && dy === 1) {
                            this.segments[i].drawElement(1, 1, "Blue");
                        }

                        for (var p = 1; p < canvas.width/blockSize; p++) {
                            var ax = this.segments[i].col+dx*p;
                            var ay = this.segments[i].row+dy*p;

                            if (ax === apple.position.col && ay === apple.position.row) {
                                if (dx === -1 && dy === 0) {
                                    this.segments[i].drawElement(3, 2, "Blue");
                                }
                                if (dx === 0 && dy === -1) {
                                    this.segments[i].drawElement(3, 3, "Blue");
                                }
                                if (dx === 1 && dy === 0) {
                                    this.segments[i].drawElement(3, 0, "Blue");
                                }
                                if (dx === 0 && dy === 1) {
                                    this.segments[i].drawElement(3, 1, "Blue");
                                }
                            }
                        }
                    } else {
                        var x1 = this.segments[i+1].col;
                        var x2 = this.segments[i].col;
                        var x3 = this.segments[i-1].col;

                        var y1 = this.segments[i+1].row;
                        var y2 = this.segments[i].row;
                        var y3 = this.segments[i-1].row;

                        var dx = x1+x3-2*x2;
                        var dy = y1+y3-2*y2;

                        if (dx === -1 && dy === 1) {
                            this.segments[i].drawElement(2, 0, "Blue");
                        } else 
                        if (dx === -1 && dy === -1) {
                            this.segments[i].drawElement(2, 1, "Blue");
                        } else 
                        if (dx === 1 && dy === -1) {
                            this.segments[i].drawElement(2, 2, "Blue");
                        } else
                        if (dx === 1 && dy === 1) {
                            this.segments[i].drawElement(2, 3, "Blue");
                        } else this.segments[i].drawSquare("Blue");
                    }
                }
            }

            Snake.prototype.move = function () {
                var head = this.segments[0];
                var newHead;

                this.direction = this.nextDirection;

                if (this.direction === "right") {
                    newHead = new Block(head.col + 1, head.row);
                } else if (this.direction === "down") {
                    newHead = new Block(head.col, head.row + 1);
                } else if (this.direction === "left") { 
                    newHead = new Block(head.col - 1, head.row);
                } else if (this.direction === "up") {
                    newHead = new Block(head.col, head.row - 1);
                }

                if (this.checkCollision(newHead)) {
                    gameOver();
                    return;
                }

                this.segments.unshift(newHead);
 
                if (newHead.equal(apple.position)) {
                    score++;
                    apple.move();
                } else {
                    this.segments.pop();
                }
            }

            Snake.prototype.checkCollision = function (head) {
                var leftCollision = (head.col === 0);
                var topCollision = (head.row === 0);
                var rightCollision = (head.col === widthInBlocks - 1);
                var bottomCollision = (head.row === heightInBlocks);

                var wallCollision = leftCollision || topCollision || rightCollision || bottomCollision;

                var selfCollision = false;

                for (var i = 0; i < this.segments.length; i++) {
                    if (head.equal(this.segments[i])) {
                        selfCollision = true;
                    }
                }

                return wallCollision || selfCollision;
            }

            Snake.prototype.setDirection = function (newDirection) {
                if (this.direction === "up" && newDirection === "down") {
                    return;
                } else if (this.direction === "down" && newDirection === "up") {
                    return;
                } else if (this.direction === "right" && newDirection === "left") {
                    return;
                } else if (this.direction === "left" && newDirection === "right") {
                    return;
                }

                this.nextDirection = newDirection;
            }

            function Apple() {
                var randomCol = Math.floor(Math.random() * (widthInBlocks - 2)) + 1;
                var randomRow = Math.floor(Math.random() * (heightInBlocks - 2)) + 1;
                this.position = new Block(randomCol, randomRow);
            }

            Apple.prototype.draw = function () {
                this.position.drawElement(4, 0, "Red");
            }

            Apple.prototype.move = function () {
                var randomCol = Math.floor(Math.random() * (widthInBlocks - 2)) + 1;
                var randomRow = Math.floor(Math.random() * (heightInBlocks - 2)) + 1;
                this.position = new Block(randomCol, randomRow);
            }

            var apple = new Apple();
            var snake = new Snake();

            var intervalId = setInterval(function () {
                ctx.clearRect(0, 0, width, height);
                drawBoard();
                drawScore();
                snake.move();
                snake.draw();
                apple.draw();
                drawBorder();
            }, 100);

            var directions = {
                37: "left", 
                38: "up", 
                39: "right", 
                40: "down"
            }

            $('body').keydown(function (event) {
                var newDirection = directions[event.keyCode];
                if (newDirection) snake.setDirection(newDirection);
            });
            
        </script>

        <style>
            #canvas{
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }

            #score{
                font-family: "Comic Sans MS", Courier;
                font-size: 30px;
            }
        </style>
    </body>
</html>